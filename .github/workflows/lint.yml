name: Code Quality (Linting & Formatting)

# Trigger on PRs and pushes to main/development branches
on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.13"]
        node-version: ["18.17.1"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Python: Setup and linting
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff

      - name: Run Black (Python formatter)
        run: |
          black --check --diff backend/starlink-location/app backend/starlink-location/tests
        continue-on-error: true

      - name: Run Ruff (Python linter)
        run: |
          ruff check backend/starlink-location/app backend/starlink-location/tests
        continue-on-error: true

      # Node.js: Setup and linting
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: frontend/mission-planner/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend/mission-planner
          npm ci --legacy-peer-deps

      - name: Run Prettier (JS/TS/MD formatter)
        run: |
          cd frontend/mission-planner
          npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,md}"
        continue-on-error: true

      - name: Run ESLint (JS/TS linter)
        run: |
          cd frontend/mission-planner
          npx eslint src --ext .ts,.tsx
        continue-on-error: true

      # Markdown linting
      - name: Run markdownlint-cli2 (Markdown linter)
        run: |
          npm install -g markdownlint-cli2
          markdownlint-cli2 "docs/**/*.md"
        continue-on-error: true

      # Summary
      - name: Linting Summary
        if: always()
        run: |
          echo "## Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Linting checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tools Run:**" >> $GITHUB_STEP_SUMMARY
          echo "- Black (Python formatter)" >> $GITHUB_STEP_SUMMARY
          echo "- Ruff (Python linter)" >> $GITHUB_STEP_SUMMARY
          echo "- Prettier (JS/TS/MD formatter)" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint (JS/TS linter)" >> $GITHUB_STEP_SUMMARY
          echo "- Markdownlint-cli2 (Markdown linter)" >> $GITHUB_STEP_SUMMARY
