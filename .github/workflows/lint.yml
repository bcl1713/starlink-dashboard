name: Code Quality (Linting & Formatting)

# Trigger on PRs and pushes to main/development branches
on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.13"]
        node-version: ["22"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Python: Setup and linting
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff

      - name: Run Black (Python formatter)
        id: black
        run: |
          black --check --diff backend/starlink-location/app backend/starlink-location/tests
        continue-on-error: true

      - name: Run Ruff (Python linter)
        id: ruff
        run: |
          ruff check backend/starlink-location/app backend/starlink-location/tests
        continue-on-error: true

      # Naming convention check
      - name: Check Naming Conventions
        id: naming
        run: |
          python tools/check_filename_convention.py
        continue-on-error: true

      # Node.js: Setup and linting
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: frontend/mission-planner/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend/mission-planner
          npm ci --legacy-peer-deps

      - name: Run Prettier (JS/TS/MD formatter)
        id: prettier
        run: |
          cd frontend/mission-planner
          npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,md}"
        continue-on-error: true

      - name: Run ESLint (JS/TS linter)
        id: eslint
        run: |
          cd frontend/mission-planner
          npx eslint src --ext .ts,.tsx
        continue-on-error: true

      # Markdown linting
      - name: Run markdownlint-cli2 (Markdown linter)
        id: markdownlint
        run: |
          npm install -g markdownlint-cli2
          markdownlint-cli2 "docs/**/*.md"
        continue-on-error: true

      # Link checking
      - name: Link Checker (Lychee)
        id: lychee
        uses: lycheeverse/lychee-action@v1.9.1
        with:
          args: --no-progress docs/
          fail: true
        continue-on-error: true

      # Summary
      - name: Linting Summary
        if: always()
        run: |
          echo "## Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          failures=0

          check_status() {
            if [ "$1" == "failure" ]; then
              echo "âŒ $2 failed" >> $GITHUB_STEP_SUMMARY
              failures=$((failures+1))
            else
              echo "âœ… $2 passed" >> $GITHUB_STEP_SUMMARY
            fi
          }

          check_status "${{ steps.black.outcome }}" "Black (Python formatter)"
          check_status "${{ steps.ruff.outcome }}" "Ruff (Python linter)"
          check_status "${{ steps.naming.outcome }}" "Naming Conventions"
          check_status "${{ steps.prettier.outcome }}" "Prettier (JS/TS/MD formatter)"
          check_status "${{ steps.eslint.outcome }}" "ESLint (JS/TS linter)"
          check_status "${{ steps.markdownlint.outcome }}" "Markdownlint (Markdown linter)"
          check_status "${{ steps.lychee.outcome }}" "Lychee (Link Checker)"

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $failures -gt 0 ]; then
            echo "ðŸ”´ $failures checks failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "ðŸŸ¢ All checks passed" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
